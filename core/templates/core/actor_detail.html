{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ display_name }} - Detaylar{% endblock %}

{% block content %}

<div class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Profile Section -->
        <div class="flex flex-col md:flex-row gap-8 mb-8">
            <!-- Profile Photo -->
            <div class="w-full md:w-64 flex-shrink-0">
                <div class="relative group aspect-[2/3] bg-slate-200 rounded-lg overflow-hidden shadow-lg border border-slate-200 flex items-center justify-center">
                    <!-- Image -->
                    <img id="profilePhoto" 
                         src="{% if profile_photo_url %}{{ MEDIA_URL }}{{ profile_photo_url }}?t={% now 'U' %}{% endif %}" 
                         alt="{{ display_name }}"
                         class="w-full h-full object-cover {% if not profile_photo_url %}hidden{% endif %}">
                    
                    <!-- Placeholder -->
                    <div id="profilePlaceholder" class="flex flex-col items-center justify-center text-slate-400 {% if profile_photo_url %}hidden{% endif %}">
                        <i class="bi bi-person-fill text-8xl"></i>
                    </div>
                    
                    <!-- Overlay Controls -->
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-3 p-4">
                        <label for="profileUpload" class="px-4 py-2 bg-white/90 hover:bg-white text-slate-900 rounded-lg font-semibold cursor-pointer transition-colors w-full text-center text-sm shadow-sm">
                            <i class="bi bi-camera-fill mr-2"></i><span id="uploadLabelText">{% if profile_photo_url %}Değiştir{% else %}Fotoğraf Ekle{% endif %}</span>
                        </label>
                        <input type="file" id="profileUpload" accept="image/*" class="hidden">
                        
                        <button id="removeProfileBtn" onclick="removeProfilePhoto()" 
                                class="px-4 py-2 bg-red-600/90 hover:bg-red-600 text-white rounded-lg font-semibold transition-colors w-full text-center text-sm shadow-sm {% if not profile_photo_url %}hidden{% endif %}">
                            <i class="bi bi-trash mr-2"></i>Kaldır
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="flex-1">
                <a href="{% url 'core:actors_dashboard' %}" class="inline-flex items-center gap-2 text-sky-600 hover:text-sky-700 font-medium mb-4 transition-colors">
                    <i class="bi bi-chevron-left"></i>Geri Dön
                </a>
                <h1 class="text-4xl font-bold text-slate-900 mb-4">{{ display_name }}</h1>
                
                <div class="flex gap-4 text-slate-600 mb-6">
                    <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm">
                        <i class="bi bi-film text-sky-600 text-lg"></i>
                        <span class="font-semibold text-slate-900">{{ movie_count }}</span> Film
                    </div>
                    <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm">
                        <i class="bi bi-image-multiple text-sky-600 text-lg"></i>
                        <span class="font-semibold text-slate-900">{{ photo_count }}</span> Kare
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Photo Gallery -->
        <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
            <div class="bg-slate-50 border-b border-slate-200 px-6 py-4">
                <h5 class="font-bold text-slate-900">
                    <i class="bi bi-image-multiple mr-2 text-sky-600"></i>Tüm Fotoğraflar ({{ photo_count }})
                </h5>
            </div>
            <div class="p-6">
                <!-- Toolbar (Always Visible) -->
                <div class="flex items-center justify-between mb-4">
                    <div class="flex gap-2">
                        <label for="photoUpload" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors cursor-pointer shadow-sm">
                            <i class="bi bi-plus-circle"></i>Fotoğraf Ekle
                        </label>
                        <input type="file" id="photoUpload" accept="image/*" multiple class="hidden" onchange="uploadPhotos(this)">
                    </div>
                    {% if photos %}
                    <span class="text-sm text-slate-600">{{ photos|length }} Fotoğraf</span>
                    {% endif %}
                </div>

                {% if photos %}
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    {% for photo in photos %}
                    <div class="relative photo-item group" x-data="photoCard('{{ photo.path }}', '{{ actor_name }}', {{ photo.is_embedded|yesno:'true,false' }})" data-photo-path="{{ photo.path }}">
                        <img src="{{ MEDIA_URL }}{{ photo.path }}" 
                             alt="{{ display_name }}"
                             class="w-full aspect-square object-cover rounded-lg shadow-sm group-hover:shadow-md transition-all group-hover:scale-105"
                             loading="lazy"
                             @click="openImageModal('{{ MEDIA_URL }}{{ photo.path }}', '{{ display_name }}')">
                        
                        <!-- Status Indicator (Embedded) -->
                        <div x-show="embedded" class="absolute top-2 right-2 w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow-sm z-10" title="Veritabanında Kayıtlı"></div>

                        <!-- Hover Overlay with Actions -->
                        <div class="absolute inset-0 bg-black/60 rounded-lg flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity gap-3">
                            
                            <!-- View -->
                            <button @click="openImageModal('{{ MEDIA_URL }}{{ photo.path }}', '{{ display_name }}')" 
                                    class="text-white hover:text-sky-400 transition-colors" title="Büyüt">
                                <i class="bi bi-eye text-2xl"></i>
                            </button>

                            <div class="flex gap-2">
                                <!-- Embedding Toggle -->
                                <button @click="toggle()"
                                        class="w-8 h-8 rounded-full flex items-center justify-center transition-colors border border-white/20"
                                        :class="embedded ? 'bg-amber-500/20 text-amber-400 hover:bg-amber-500 hover:text-white' : 'bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-white'"
                                        :title="embedded ? 'Veritabanından Çıkar' : 'Veritabanına Ekle'">
                                    <i class="bi" :class="loading ? 'bi-hourglass-split animate-pulse' : (embedded ? 'bi-database-dash' : 'bi-database-add')"></i>
                                </button>

                                <!-- Delete -->
                                <button onclick="deletePhoto('{{ photo.path }}', '{{ actor_name }}')" 
                                        class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white flex items-center justify-center transition-colors border border-white/20"
                                        title="Fotoğrafı Sil">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-slate-50 rounded-lg border-2 border-dashed border-slate-300 py-12 text-center group hover:bg-slate-100 transition-colors cursor-pointer" onclick="document.getElementById('photoUpload').click()">
                    <i class="bi bi-cloud-upload text-slate-400 text-5xl mb-4 block group-hover:text-green-500 transition-colors"></i>
                    <h5 class="font-semibold text-slate-900 mb-2">Henüz fotoğraf yok</h5>
                    <p class="text-slate-500 text-sm">Fotoğraf yüklemek için tıklayın veya sürükleyin</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="closeImageModal(event)">
    <div class="bg-white rounded-lg shadow-2xl w-auto max-w-[95vw] h-auto max-h-[90vh] flex flex-col" onclick="event.stopPropagation()">
        <div class="bg-slate-900 text-white px-6 py-4 flex justify-between items-center rounded-t-lg flex-shrink-0">
            <h5 class="font-bold truncate max-w-xs" id="modalTitle">{{ display_name }}</h5>
            <button onclick="closeImageModal()" class="text-xl hover:text-slate-300 transition-colors ml-4">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="flex-1 bg-slate-900 flex items-center justify-center overflow-auto rounded-b-lg p-2">
            <img id="modalImage" src="" alt="" class="max-w-full max-h-[80vh] object-contain">
        </div>
    </div>
</div>

<script>
const ACTOR_NAME = '{{ actor_name }}';

function openImageModal(imageSrc, actorName) {
    const modal = document.getElementById('imageModal');
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('modalTitle').textContent = actorName;
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeImageModal(event) {
    if (event && event.target.id !== 'imageModal') return;
    const modal = document.getElementById('imageModal');
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Escape key to close modal
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
    }
});

// Delete Photo
function deletePhoto(photoPath, actorName) {
    const photoElement = document.querySelector(`[data-photo-path="${photoPath}"]`);
    
    fetch('{% url "core:delete_single_face" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `face_path=${encodeURIComponent(photoPath)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animasyon ile kaldır
            photoElement.style.opacity = '0';
            photoElement.style.transform = 'scale(0.8)';
            setTimeout(() => {
                photoElement.remove();
                // Sayfayı 2 saniye sonra yenile
                setTimeout(() => location.reload(), 1000);
            }, 300);
        } else {
            alert('Fotoğraf silinemedi: ' + (data.message || 'Bilinmeyen hata'));
        }
    })
    .catch(error => {
        console.error('Silme hatası:', error);
        alert('Fotoğraf silinirken hata oluştu');
    });
}

// Upload Photo
document.getElementById('photoUpload')?.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    // Aktör klasörünü oluştur/kontrol et
    const actorDir = `labeled_faces/${ACTOR_NAME}`;
    
    files.forEach((file, index) => {
        const formData = new FormData();
        formData.append('photo', file);
        formData.append('actor_name', ACTOR_NAME);

        // Upload progress göster
        const uploadBtn = document.querySelector('label[for="photoUpload"]');
        const originalText = uploadBtn.innerHTML;
        
        fetch('{% url "core:upload_photo" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Son dosya yüklendiyse sayfayı yenile
                if (index === files.length - 1) {
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                alert(`${file.name} yüklenemedi: ${data.message || 'Bilinmeyen hata'}`);
            }
        })
        .catch(error => {
            console.error('Upload hatası:', error);
            alert('Fotoğraf yüklenirken hata oluştu');
        });
    });

    // Input'u sıfırla
    this.value = '';
});

// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
// Profile Photo Management
document.getElementById('profileUpload')?.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('photo', file);
    formData.append('actor_name', ACTOR_NAME);

    // Show loading state if desired
    const label = document.querySelector('label[for="profileUpload"]');
    const originalText = label.innerHTML;
    label.innerHTML = '<i class="bi bi-arrow-repeat animate-spin mr-2"></i>Yükleniyor...';

    fetch('{% url "core:update_profile_photo" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update Image
            const img = document.getElementById('profilePhoto');
            img.src = data.url + '?t=' + new Date().getTime();
            img.classList.remove('hidden');
            
            // Hide Placeholder
            document.getElementById('profilePlaceholder').classList.add('hidden');
            
            // Show Remove Button
            document.getElementById('removeProfileBtn').classList.remove('hidden');
            
            // Update Label Text
            label.innerHTML = '<i class="bi bi-camera-fill mr-2"></i>Değiştir';
        } else {
            alert('Hata: ' + data.message);
            label.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Fotoğraf yüklenirken hata oluştu');
        label.innerHTML = originalText;
    });
});

function removeProfilePhoto() {
    if (!confirm('Profil fotoğrafını kaldırmak istediğinize emin misiniz?')) return;

    const formData = new FormData();
    formData.append('actor_name', ACTOR_NAME);

    fetch('{% url "core:remove_profile_photo" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset to placeholder
            const img = document.getElementById('profilePhoto');
            img.src = "";
            img.classList.add('hidden');
            
            // Show Placeholder
            document.getElementById('profilePlaceholder').classList.remove('hidden');
            
            // Hide Remove Button
            document.getElementById('removeProfileBtn').classList.add('hidden');
            
            // Update Label Text
            const label = document.querySelector('label[for="profileUpload"]');
            label.innerHTML = '<i class="bi bi-camera-fill mr-2"></i>Fotoğraf Ekle';
        } else {
            alert('Hata: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Silme sırasında hata oluştu');
    });
}
// Photo Card Component
document.addEventListener('alpine:init', () => {
    Alpine.data('photoCard', (photoPath, actorName, initialEmbedded) => ({
        embedded: initialEmbedded,
        loading: false,

        async toggle() {
            if (this.loading) return;
            this.loading = true;
            
            try {
                const formData = new FormData();
                formData.append('actor_name', actorName);
                formData.append('photo_path', photoPath);
                
                const res = await fetch('{% url "core:toggle_embedding" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                });
                
                const data = await res.json();
                if (data.success) {
                    this.embedded = data.is_embedded;
                    // Optional: Show toast or feedback
                } else {
                    alert('Hata: ' + data.message);
                }
            } catch (e) {
                console.error(e);
                alert('İşlem sırasında hata oluştu.');
            } finally {
                this.loading = false;
            }
        }
    }));
});
</script>
{% endblock %}
