{% extends 'core/base.html' %}
{% load static %}

{% block title %}Yüz Tanıma Stüdyosu{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900 text-white" x-data="recognitionStudio()">

    <!-- Top Bar -->
    <div class="bg-slate-800 border-b border-white/10 px-8 py-4 flex items-center justify-between sticky top-0 z-50 shadow-xl">
        <div class="flex items-center gap-4">
            <div class="bg-gradient-to-tr from-cyan-500 to-blue-600 w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <i class="bi bi-camera-reels text-white text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">Yüz Tanıma Stüdyosu</h1>
                <p class="text-slate-400 text-xs text-opacity-80">Video Analiz ve Canlı Tanıma</p>
            </div>
        </div>

        <!-- Mobile Settings Toggle -->
        <button @click="showSettings = !showSettings" 
                class="md:hidden w-10 h-10 flex items-center justify-center bg-slate-800 rounded-lg border border-white/10 text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">
            <i class="bi" :class="showSettings ? 'bi-x-lg' : 'bi-sliders'"></i>
        </button>

        <!-- Configuration Controls -->
        <div class="absolute top-full left-0 right-0 p-6 bg-slate-900/95 backdrop-blur-xl border-b border-white/10 flex flex-col gap-6 shadow-2xl transition-all duration-300 origin-top z-40 md:static md:bg-slate-900/50 md:p-0 md:flex-row md:gap-6 md:px-6 md:py-2 md:rounded-xl md:border md:border-white/5 md:shadow-none"
             :class="showSettings ? 'scale-y-100 opacity-100 visible' : 'scale-y-0 opacity-0 invisible md:visible md:scale-y-100 md:opacity-100'"
             x-cloak>
            <!-- Threshold -->
            <div class="flex flex-col w-full md:w-auto">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Benzerlik</span>
                    <span class="text-[10px] font-mono text-cyan-400" x-text="config.threshold"></span>
                </div>
                <input type="range" x-model="config.threshold" min="0.1" max="0.9" step="0.01" 
                       class="w-full md:w-24 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>

            <!-- Buffer -->
            <div class="flex flex-col w-full md:w-auto">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Buffer</span>
                    <span class="text-[10px] font-mono text-cyan-400" x-text="config.buffer"></span>
                </div>
                <input type="range" x-model="config.buffer" min="1" max="60" step="1" 
                       class="w-full md:w-24 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>
            
            <!-- Min Size -->
            <div class="flex flex-col w-full md:w-auto">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Min Boyut</span>
                    <span class="text-[10px] font-mono text-cyan-400" x-text="config.min_face_size + 'px'"></span>
                </div>
                <input type="range" x-model="config.min_face_size" min="20" max="200" step="10" 
                       class="w-full md:w-24 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>

            <!-- Max Blur -->
            <div class="flex flex-col w-full md:w-auto">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Max Blur</span>
                    <span class="text-[10px] font-mono text-cyan-400" x-text="config.min_blur"></span>
                </div>
                <input type="range" x-model="config.min_blur" min="0" max="500" step="10" 
                       class="w-full md:w-24 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-2">
            <button @click="updateStream()" 
                    x-show="state === 'STREAMING' || state === 'COMPLETED'"
                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-lg shadow-emerald-500/20">
                <i class="bi bi-play-circle"></i> Ayarları Uygula
            </button>

            <button @click="reset()" 
                    x-show="state !== 'IDLE'"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <i class="bi bi-arrow-repeat"></i> Yeni Analiz
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 min-h-[calc(100vh-80px)] flex flex-col">
        
        <!-- STATE: IDLE (Upload) -->
        <div x-show="state === 'IDLE'" class="max-w-2xl mx-auto w-full animate-fade-in-up">
            
            <!-- Context Selector (Optional) -->
            <div class="mb-8 bg-slate-800/50 backdrop-blur-sm border border-white/5 rounded-2xl p-6 relative">
                <label class="text-sm font-bold text-slate-400 mb-2 block uppercase tracking-wider">
                    <i class="bi bi-film text-cyan-500 mr-2"></i>Film Bağlamı (Opsiyonel)
                </label>
                <p class="text-xs text-slate-500 mb-4">
                    Eğer videonun hangi filme ait olduğunu biliyorsanız, buradan seçerek tanıma doğruluğunu artırabilirsiniz. 
                    Sistem sadece bu filmin oyuncularına odaklanacaktır.
                </p>
                
                <div class="relative">
                    <input type="text" 
                           x-model="searchQuery" 
                           @input.debounce.300ms="searchMovies()"
                           placeholder="Film adı ara..." 
                           class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500 transition-colors">
                    
                    <div x-show="searchQuery.length > 0 && !selectedMovie" class="absolute right-4 top-3.5">
                        <i class="bi bi-search text-slate-500"></i>
                    </div>

                    <!-- Selected Pill -->
                    <div x-show="selectedMovie" class="absolute right-2 top-2 bg-cyan-500/10 border border-cyan-500/30 text-cyan-400 px-3 py-1.5 rounded-lg flex items-center gap-2 text-sm cursor-pointer hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/30 transition-colors" @click="clearSelection()">
                        <span x-text="selectedMovie ? selectedMovie.title : ''" class="font-bold"></span>
                        <i class="bi bi-x-lg text-xs"></i>
                    </div>

                    <!-- Dropdown -->
                    <div x-show="searchResults.length > 0" class="absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden max-h-60 overflow-y-auto">
                        <template x-for="movie in searchResults" :key="movie.id">
                            <div @click="selectMovie(movie)" class="px-4 py-3 hover:bg-white/5 cursor-pointer flex items-center gap-3 transition-colors border-b border-white/5 last:border-0">
                                <i class="bi bi-film text-slate-500"></i>
                                <span x-text="movie.title" class="text-slate-300"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800/50 backdrop-blur-sm border border-white/5 rounded-2xl p-12 text-center relative group hover:border-cyan-500/30 transition-all duration-300"
                 @dragover.prevent="dragging = true"
                 @dragleave.prevent="dragging = false"
                 @drop.prevent="handleDrop($event)"
                 :class="dragging ? 'border-cyan-500 bg-cyan-500/10' : ''">
                
                <input type="file" id="videoInput" accept="video/*" class="hidden" @change="handleFileSelect($event)">
                
                <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-300 shadow-xl">
                    <i class="bi bi-cloud-upload text-4xl text-cyan-400"></i>
                </div>
                
                <h2 class="text-3xl font-bold text-white mb-3">Video Yükle</h2>
                <p class="text-slate-400 mb-8 max-w-md mx-auto">Sürükleyip bırakın veya bilgisayarınızdan seçin. MP4, AVI, MOV formatları desteklenir.</p>
                
                <label for="videoInput" class="inline-flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-cyan-500/25 cursor-pointer transform hover:-translate-y-1">
                    <i class="bi bi-folder2-open"></i> Dosya Seç
                </label>
            </div>
        </div>

        <!-- STATE: UPLOADING -->
        <div x-show="state === 'UPLOADING'" class="max-w-md mx-auto w-full text-center animate-fade-in">
            <div class="mb-6 relative">
                 <div class="w-20 h-20 border-4 border-slate-700 border-t-cyan-500 rounded-full animate-spin mx-auto"></div>
                 <div class="absolute inset-0 flex items-center justify-center">
                     <span class="text-xs font-bold font-mono text-cyan-500" x-text="uploadProgress + '%'"></span>
                 </div>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Video Yükleniyor...</h3>
            <p class="text-slate-400 text-sm">Lütfen bekleyin, dosya sunucuya aktarılıyor.</p>
        </div>

        <!-- STATE: STREAMING -->
        <div x-show="state === 'STREAMING' || state === 'COMPLETED'" class="w-full max-w-5xl mx-auto flex flex-col animate-fade-in">
            
            <div class="relative w-full aspect-video bg-black rounded-2xl overflow-hidden border border-white/10 shadow-2xl flex items-center justify-center group">
                
                <!-- Loading Indicator (Behind Stream) -->
                <div class="absolute inset-0 flex items-center justify-center z-0">
                    <div class="text-center opacity-50">
                        <div class="w-12 h-12 border-2 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-slate-400 text-sm blink">Analiz Başlatılıyor...</p>
                    </div>
                </div>

                <!-- The Stream Image -->
                <img x-ref="streamImg"
                     :src="streamUrl"
                     class="max-w-full max-h-full object-contain relative z-10"
                     @load="streamLoaded = true"
                     @error="handleStreamError">

                <!-- Completion Overlay -->
                <div x-show="state === 'COMPLETED'" class="absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-20 animate-fade-in">
                   <div class="text-center p-8 bg-slate-800 rounded-2xl border border-white/10 shadow-2xl max-w-sm">
                       <i class="bi bi-check-circle-fill text-5xl text-emerald-500 mb-4 block"></i>
                       <h3 class="text-2xl font-bold text-white mb-2">Analiz Tamamlandı</h3>
                       <p class="text-slate-400 mb-6">Video işleme başarıyla bitirildi.</p>
                       <button @click="reset()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors">
                           Yeni Video Yükle
                       </button>
                   </div>
                </div>
            </div>
            
            <!-- Info Bar -->
            <div class="mt-4 flex items-center justify-center gap-6 text-sm text-slate-400">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span>Canlı Akış (MJPEG)</span>
                </div>
                <div class="w-px h-4 bg-white/10"></div>
                <div>Config: <span class="text-cyan-400 font-mono" x-text="`T:${config.threshold} | B:${config.buffer}`"></span></div>
            </div>

        </div>

            <!-- Real-time Stats -->
        <div x-show="state === 'STREAMING' || state === 'COMPLETED'" class="mt-8 w-full max-w-5xl mx-auto animate-fade-in-up">
            <h3 class="text-lg font-bold text-white mb-4 border-l-4 border-cyan-500 pl-3">Tespit Edilen Kişiler</h3>
            
            <!-- Widened Grid: lg:grid-cols-3 instead of 4 for wider cards -->
            <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-6">
                <template x-for="actor in actors" :key="actor.name">
                    <div class="bg-slate-800/50 border border-white/5 rounded-2xl p-5 flex flex-col gap-3 hover:border-cyan-500/30 transition-colors relative overflow-hidden group">
                        
                        <!-- Header Row -->
                        <div class="flex items-center justify-between">
                             <div class="flex items-center gap-4">
                                <!-- Image Circle -->
                                <div class="relative w-16 h-16 shrink-0">
                                    <template x-if="actor.image">
                                        <img :src="actor.image" class="w-16 h-16 rounded-full object-cover border-2 border-slate-600 shadow-lg">
                                    </template>
                                    <template x-if="!actor.image">
                                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-cyan-600 to-blue-700 flex items-center justify-center text-xl font-bold ring-2 ring-white/10 text-white shadow-lg" 
                                             x-text="actor.name.substring(0,1).toUpperCase()"></div>
                                    </template>
                                    <!-- Status Dot -->
                                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-emerald-500 border-2 border-slate-800 rounded-full"></div>
                                </div>
                                
                                <div class="min-w-0">
                                    <div class="font-bold text-slate-100 text-lg truncate leading-tight" x-text="actor.name"></div>
                                    <div class="text-xs text-slate-400 mt-1 flex items-center gap-2">
                                        <span class="bg-slate-700/50 px-2 py-0.5 rounded text-cyan-300 font-mono" x-text="actor.count + ' kare'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Embedding / Info Footer -->
                        <div class="pt-3 mt-1 border-t border-white/5 flex items-center justify-between text-xs">
                            <template x-if="actor.is_guest">
                                <div class="flex items-center gap-2 w-full">
                                    <span class="flex items-center gap-1.5 text-amber-400 bg-amber-400/10 px-2 py-1 rounded-md border border-amber-400/20 whitespace-nowrap">
                                        <i class="bi bi-exclamation-circle"></i> 
                                        <span>Kayıtlı Değil</span>
                                    </span>
                                    
                                    <!-- Enroll Button (Re-Added) -->
                                    <button @click="enrollGuest(actor)" 
                                            class="ml-auto px-3 py-1 bg-cyan-600 hover:bg-cyan-500 text-white rounded-md font-bold transition-colors shadow-lg shadow-cyan-500/20 flex items-center gap-1">
                                        <i class="bi bi-person-plus-fill"></i> Kaydet
                                    </button>
                                </div>
                            </template>
                            
                            <template x-if="!actor.is_guest">
                                <span class="flex items-center gap-1.5 text-blue-400 bg-blue-400/10 px-2 py-1 rounded-md border border-blue-400/20">
                                    <i class="bi bi-database-check"></i> 
                                    <span>Tanımlı</span>
                                </span>
                            </template>
                        </div>

                    </div>
                </template>
                
                <!-- No Detections Yet -->
                <div x-show="actors.length === 0" class="col-span-full flex flex-col items-center justify-center py-16 px-4 bg-slate-800/30 rounded-3xl border border-white/5 border-dashed">
                    <div class="animate-pulse w-16 h-16 rounded-full bg-slate-800 mb-4 flex items-center justify-center">
                        <i class="bi bi-search text-cyan-500/50 text-2xl"></i>
                    </div>
                    <p class="text-slate-400 text-base font-medium">Yüzler Taranıyor...</p>
                    <p class="text-slate-500 text-sm mt-1">Henüz veritabanında kayıtlı bir kişi tespit edilmedi.</p>
                </div>
            </div>
            
            <!-- Connection Status -->
            <div class="text-right mt-2">
                 <span class="inline-flex items-center gap-1.5 px-2 py-1 rounded bg-slate-800/50 border border-white/5 text-[10px] text-slate-500 font-mono">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    SYNC AKTİF
                 </span>
            </div>
        </div>

    </div>
</div>

<script>
function recognitionStudio() {
    return {
        state: 'IDLE', // IDLE, UPLOADING, STREAMING, COMPLETED
        showSettings: false,
        dragging: false,
        uploadProgress: 0,
        streamUrl: '',
        streamLoaded: false,
        sessionId: null, // Store active session ID
        stats: {}, // Deprecated: Raw stats dict
        actors: [], // New: Enriched actor list
        
        // Movie Context
        searchQuery: '',
        searchResults: [],
        selectedMovie: null,
        
        config: {
            threshold: 0.27,
            buffer: 60,
            min_face_size: 20,
            min_blur: 0
        },

        init() {
            console.log("Recognition Studio Initialized");
        },
        
        async searchMovies() {
            if (this.selectedMovie || this.searchQuery.length < 2) {
                this.searchResults = [];
                return;
            }
            
            try {
                const res = await fetch(`{% url 'core:api_search_movies' %}?q=${encodeURIComponent(this.searchQuery)}`);
                if (res.ok) {
                    this.searchResults = await res.json();
                }
            } catch(e) { console.error(e); }
        },
        
        selectMovie(movie) {
            this.selectedMovie = movie;
            this.searchResults = [];
        },
        
        clearSelection() {
            this.selectedMovie = null;
            this.searchQuery = '';
            this.searchResults = [];
        },

        handleFileSelect(e) {
            const file = e.target.files[0];
            if(file) this.uploadFile(file);
        },

        handleDrop(e) {
            this.dragging = false;
            const file = e.dataTransfer.files[0];
            if(file && file.type.startsWith('video/')) this.uploadFile(file);
        },

        uploadFile(file) {
            this.state = 'UPLOADING';
            this.uploadProgress = 0;
            
            const formData = new FormData();
            formData.append('video', file);
            if (this.selectedMovie) {
                formData.append('movie_id', this.selectedMovie.id);
            }
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    this.uploadProgress = Math.round((e.loaded / e.total) * 100);
                }
            };
            
            xhr.onload = () => {
                if (xhr.status === 200) {
                    try {
                        const resp = JSON.parse(xhr.responseText);
                        if (resp.success) {
                            console.log("Upload success, starting session:", resp.session_id);
                            this.startStream(resp.session_id);
                        } else {
                            alert('Yükleme hatası: ' + resp.error);
                            this.state = 'IDLE';
                        }
                    } catch(e) {
                        console.error(e);
                        alert('Sunucu yanıtı geçersiz.');
                        this.state = 'IDLE';
                    }
                } else {
                    alert('Yükleme başarısız. Status: ' + xhr.status);
                    this.state = 'IDLE';
                }
            };
            
            xhr.onerror = () => {
                alert('Ağ hatası oluştu.');
                this.state = 'IDLE';
            };
            
            xhr.open('POST', '{% url "core:recognition_upload" %}');
            xhr.send(formData);
        },

        startStream(sessionId) {
            this.sessionId = sessionId;
            this.state = 'STREAMING';
            this.stats = {}; 
            this.actors = [];
            this.updateStream();
            
            // Start Polling Loop
            this.pollStatsLoop();
        },

        async pollStatsLoop() {
            if (!this.sessionId || this.state === 'IDLE') return;

            try {
                // Fetch stats
                const res = await fetch(`{% url 'core:api_recognition_status' %}?session_id=${this.sessionId}`);
                if (res.ok) {
                    const data = await res.json();
                    
                    // UPDATE actors list
                    if (data.actors) {
                        this.actors = data.actors;
                        this.stats = data.stats; // Keep for fallback logic if needed
                    } else if (data.stats) {
                        // Fallback if backend doesn't send actors yet
                        this.stats = data.stats;
                        this.actors = Object.entries(data.stats).map(([name, count]) => ({name, count, image: null}));
                    }
                    
                    if (data.status === 'completed') {
                        console.log("Backend reports completed.");
                        this.state = 'COMPLETED';
                        return; // Stop polling
                    }
                }
            } catch (e) {
                console.error("Polling error:", e);
            }

            // Loop if still streaming
            if (this.state === 'STREAMING') {
                setTimeout(() => this.pollStatsLoop(), 1000);
            }
        },

        updateStream() {
            if (!this.sessionId) return;
            
            const params = new URLSearchParams({
                threshold: this.config.threshold,
                buffer: this.config.buffer,
                min_face_size: this.config.min_face_size,
                min_blur: this.config.min_blur,
                t: Date.now() // Force reload
            });
            
            // Pass movie context if selected
            if (this.selectedMovie) {
                params.append('movie_id', this.selectedMovie.id);
            }
            
            this.state = 'STREAMING';
            this.streamLoaded = false;
            
            // Tiny delay to ensure server file system is ready
            setTimeout(() => {
                this.streamUrl = `/recognition/stream/${this.sessionId}/?${params.toString()}`;
            }, 500);
        },
        
        handleStreamError() {
            // Stream ended or broken
            if (this.streamLoaded) {
                // We rely on polling to set COMPLETED, but if stream errs keyframe, we can hint
                console.log("Stream tag error/end.");
            }
        },

        reset() {
            this.state = 'IDLE';
            this.streamUrl = '';
            this.uploadProgress = 0;
            this.sessionId = null;
            this.stats = {};
        },

        async enrollGuest(actor) {
            const guestName = actor.name;
            const defaultName = "Actor Name"; 

            const newName = prompt(`${guestName} için isim giriniz:`, defaultName);
            
            if (newName && newName !== defaultName && newName.trim() !== "") {
                try {
                    const response = await fetch('{% url "core:recognition_enroll_guest" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}' 
                        },
                        body: JSON.stringify({
                            session_id: this.sessionId,
                            guest_name: guestName,
                            actor_name: newName,
                            movie_id: this.selectedMovie ? this.selectedMovie.id : null
                        })
                    });

                    if (response.ok) {
                        const res = await response.json();
                        if (res.success) {
                            alert("Kayıt Başarılı!");
                            // Optimistic update
                            actor.name = res.actor_name;
                            actor.is_guest = false; 
                            actor.image = res.image_url; 
                        } else {
                            alert("Hata: " + res.error);
                        }
                    } else {
                         alert("Sunucu Hatası");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Bir hata oluştu.");
                }
            }
        }
    }
}
</script>
<style>
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
    
    @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
    
    .blink { animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    [x-cloak] { display: none !important; }
</style>
{% endblock %}
