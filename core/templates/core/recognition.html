{% extends 'core/base.html' %}
{% load static %}

{% block title %}Yüz Tanıma Stüdyosu{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900 text-white" x-data="recognitionStudio()">

    <!-- Top Bar -->
    <div class="bg-slate-800 border-b border-white/10 px-8 py-4 flex items-center justify-between sticky top-0 z-50 shadow-xl">
        <div class="flex items-center gap-4">
            <div class="bg-gradient-to-tr from-cyan-500 to-blue-600 w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <i class="bi bi-camera-reels text-white text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-wide">Yüz Tanıma Stüdyosu</h1>
                <p class="text-slate-400 text-xs text-opacity-80">Video Analiz ve Canlı Tanıma</p>
            </div>
        </div>

        <!-- Configuration Controls -->
        <div class="flex items-center gap-6 bg-slate-900/50 px-6 py-2 rounded-xl border border-white/5">
            <!-- Threshold -->
            <div class="flex flex-col">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Benzerlik Eşiği</span>
                    <span class="text-[10px] font-mono text-cyan-400" x-text="config.threshold"></span>
                </div>
                <input type="range" x-model="config.threshold" min="0.1" max="0.9" step="0.01" 
                       class="w-32 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>

            <!-- Separator -->
            <div class="w-px h-8 bg-white/10"></div>

            <!-- Buffer Size -->
            <div class="flex flex-col">
                <div class="flex justify-between mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Smoothing Buffer</span>
                    <span class="text-[10px] font-mono text-cyan-400" x-text="config.buffer + ' Frame'"></span>
                </div>
                <input type="range" x-model="config.buffer" min="1" max="60" step="1" 
                       class="w-32 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div>
            <button @click="reset()" 
                    x-show="state !== 'IDLE'"
                    class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <i class="bi bi-arrow-repeat"></i> Yeni Analiz
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8 h-[calc(100vh-80px)] flex flex-col justify-center">
        
        <!-- STATE: IDLE (Upload) -->
        <div x-show="state === 'IDLE'" class="max-w-2xl mx-auto w-full animate-fade-in-up">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-white/5 rounded-2xl p-12 text-center relative group hover:border-cyan-500/30 transition-all duration-300"
                 @dragover.prevent="dragging = true"
                 @dragleave.prevent="dragging = false"
                 @drop.prevent="handleDrop($event)"
                 :class="dragging ? 'border-cyan-500 bg-cyan-500/10' : ''">
                
                <input type="file" id="videoInput" accept="video/*" class="hidden" @change="handleFileSelect($event)">
                
                <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-300 shadow-xl">
                    <i class="bi bi-cloud-upload text-4xl text-cyan-400"></i>
                </div>
                
                <h2 class="text-3xl font-bold text-white mb-3">Video Yükle</h2>
                <p class="text-slate-400 mb-8 max-w-md mx-auto">Sürükleyip bırakın veya bilgisayarınızdan seçin. MP4, AVI, MOV formatları desteklenir.</p>
                
                <label for="videoInput" class="inline-flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-cyan-500/25 cursor-pointer transform hover:-translate-y-1">
                    <i class="bi bi-folder2-open"></i> Dosya Seç
                </label>
            </div>
        </div>

        <!-- STATE: UPLOADING -->
        <div x-show="state === 'UPLOADING'" class="max-w-md mx-auto w-full text-center animate-fade-in">
            <div class="mb-6 relative">
                 <div class="w-20 h-20 border-4 border-slate-700 border-t-cyan-500 rounded-full animate-spin mx-auto"></div>
                 <div class="absolute inset-0 flex items-center justify-center">
                     <span class="text-xs font-bold font-mono text-cyan-500" x-text="uploadProgress + '%'"></span>
                 </div>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Video Yükleniyor...</h3>
            <p class="text-slate-400 text-sm">Lütfen bekleyin, dosya sunucuya aktarılıyor.</p>
        </div>

        <!-- STATE: STREAMING -->
        <div x-show="state === 'STREAMING' || state === 'COMPLETED'" class="flex-1 flex flex-col min-h-0 animate-fade-in">
            
            <div class="relative w-full h-full bg-black rounded-2xl overflow-hidden border border-white/10 shadow-2xl flex items-center justify-center group">
                
                <!-- Loading Indicator (Behind Stream) -->
                <div class="absolute inset-0 flex items-center justify-center z-0">
                    <div class="text-center opacity-50">
                        <div class="w-12 h-12 border-2 border-white/20 border-t-white rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-slate-400 text-sm blink">Analiz Başlatılıyor...</p>
                    </div>
                </div>

                <!-- The Stream Image -->
                <img x-ref="streamImg"
                     :src="streamUrl"
                     class="max-w-full max-h-full object-contain relative z-10"
                     @load="streamLoaded = true"
                     @error="handleStreamError">

                <!-- Completion Overlay -->
                <div x-show="state === 'COMPLETED'" class="absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-20 animate-fade-in">
                   <div class="text-center p-8 bg-slate-800 rounded-2xl border border-white/10 shadow-2xl max-w-sm">
                       <i class="bi bi-check-circle-fill text-5xl text-emerald-500 mb-4 block"></i>
                       <h3 class="text-2xl font-bold text-white mb-2">Analiz Tamamlandı</h3>
                       <p class="text-slate-400 mb-6">Video işleme başarıyla bitirildi.</p>
                       <button @click="reset()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors">
                           Yeni Video Yükle
                       </button>
                   </div>
                </div>
            </div>
            
            <!-- Info Bar -->
            <div class="mt-4 flex items-center justify-center gap-6 text-sm text-slate-400">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span>Canlı Akış (MJPEG)</span>
                </div>
                <div class="w-px h-4 bg-white/10"></div>
                <div>Config: <span class="text-cyan-400 font-mono" x-text="`T:${config.threshold} | B:${config.buffer}`"></span></div>
            </div>

        </div>

    </div>
</div>

<script>
function recognitionStudio() {
    return {
        state: 'IDLE', // IDLE, UPLOADING, STREAMING, COMPLETED
        dragging: false,
        uploadProgress: 0,
        streamUrl: '',
        streamLoaded: false,
        
        config: {
            threshold: 0.27,
            buffer: 60
        },

        handleFileSelect(e) {
            const file = e.target.files[0];
            if(file) this.uploadFile(file);
        },

        handleDrop(e) {
            this.dragging = false;
            const file = e.dataTransfer.files[0];
            if(file && file.type.startsWith('video/')) this.uploadFile(file);
        },

        uploadFile(file) {
            this.state = 'UPLOADING';
            this.uploadProgress = 0;
            
            const formData = new FormData();
            formData.append('video', file);
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    this.uploadProgress = Math.round((e.loaded / e.total) * 100);
                }
            };
            
            xhr.onload = () => {
                if (xhr.status === 200) {
                    try {
                        const resp = JSON.parse(xhr.responseText);
                        if (resp.success) {
                            this.startStream(resp.session_id);
                        } else {
                            alert('Yükleme hatası: ' + resp.error);
                            this.state = 'IDLE';
                        }
                    } catch(e) {
                        console.error(e);
                        alert('Sunucu yanıtı geçersiz.');
                        this.state = 'IDLE';
                    }
                } else {
                    alert('Yükleme başarısız. Status: ' + xhr.status);
                    this.state = 'IDLE';
                }
            };
            
            xhr.onerror = () => {
                alert('Ağ hatası oluştu.');
                this.state = 'IDLE';
            };
            
            xhr.open('POST', '{% url "core:recognition_upload" %}');
            xhr.send(formData);
        },

        startStream(sessionId) {
            // Build URL with simplified params
            const params = new URLSearchParams({
                threshold: this.config.threshold,
                buffer_size: this.config.buffer
            });
            
            this.state = 'STREAMING';
            this.streamLoaded = false;
            
            // Tiny delay to ensure server file system is ready
            setTimeout(() => {
                this.streamUrl = `/recognition/stream/${sessionId}/?${params.toString()}`;
            }, 500);
        },

        handleStreamError() {
            // If the stream hasn't even loaded yet, it's a connection error.
            // If it loaded and then "errored", it usually means the stream ended (MJPEG end).
            if (this.streamLoaded) {
                console.log("Stream finished (MJPEG connection closed).");
                this.state = 'COMPLETED';
            } else {
                // Determine if it was an immediate fail or just end
                // We'll trust that after a few seconds, if it errors, it's done.
                if (this.state === 'STREAMING') {
                     // Can't distinguish error from end easily in generic img tag without polling
                     // Assume completed for now if it played at all
                     setTimeout(() => { this.state = 'COMPLETED'; }, 1000);
                }
            }
        },

        reset() {
            this.state = 'IDLE';
            this.streamUrl = '';
            this.uploadProgress = 0;
        }
    }
}
</script>
<style>
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 0.6s ease-out forwards; }
    
    @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
    
    .blink { animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
</style>
{% endblock %}
