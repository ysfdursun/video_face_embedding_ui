{% extends 'core/base.html' %}
{% load static %}

{% block title %}Hangi Ünlüsün?{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-900 text-white" x-data="lookalikeApp()">

    <!-- Header -->
    <div class="bg-slate-900 border-b border-slate-800 px-8 py-6 mb-8 text-center flex flex-col items-center justify-center">
        <h1 class="text-3xl font-bold text-white mb-2">
            Hangi Ünlüye Benziyorsun?
        </h1>
        <p class="text-slate-400 text-sm max-w-2xl">Yapay zeka ile en çok benzediğin ünlüleri keşfet.</p>
    </div>

    <div class="container mx-auto px-4 pb-20 max-w-5xl">
        
        <!-- Tabs -->
        <div class="flex justify-center mb-10">
            <div class="bg-slate-950 p-1 rounded-lg flex border border-slate-800">
                <button @click="mode = 'webcam'; reset()" 
                        :class="mode === 'webcam' ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-slate-800'"
                        class="px-6 py-2 rounded-md text-sm font-semibold transition-all duration-200 flex items-center gap-2">
                    <i class="bi bi-camera-video-fill"></i> Webcam
                </button>
                <button @click="mode = 'upload'; reset()"
                        :class="mode === 'upload' ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-400 hover:text-white hover:bg-slate-800'"
                        class="px-6 py-2 rounded-md text-sm font-semibold transition-all duration-200 flex items-center gap-2">
                    <i class="bi bi-cloud-upload-fill"></i> Fotoğraf Yükle
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            
            <!-- Left: Input Area -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6 shadow-xl h-full flex flex-col items-center justify-center min-h-[400px]">
                
                <!-- WEBCAM MODE -->
                <div x-show="mode === 'webcam'" class="w-full h-full flex flex-col items-center">
                    <div class="relative w-full aspect-[4/3] bg-black rounded-xl overflow-hidden border border-slate-700 shadow-sm group">
                        <video x-ref="video" class="w-full h-full object-cover transform scale-x-[-1]" autoplay playsinline muted></video>
                        
                        <!-- Overlay when inactive -->
                        <div x-show="!streamActive && !capturedImage" class="absolute inset-0 flex items-center justify-center bg-slate-900/80">
                            <button @click="startCamera()" class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-semibold transition-colors">
                                Kamerayı Başlat
                            </button>
                        </div>
                        
                        <!-- Capture Overlay -->
                        <div x-show="capturedImage" class="absolute inset-0 z-20">
                            <img :src="capturedImage" class="w-full h-full object-cover">
                        </div>
                    </div>
                    
                    <div class="mt-6 flex gap-3 w-full justify-center">
                        <button x-show="streamActive && !capturedImage" @click="capture()" class="w-14 h-14 rounded-full bg-white border-4 border-slate-200 flex items-center justify-center shadow-lg hover:scale-105 transition-transform">
                            <div class="w-10 h-10 rounded-full bg-red-500"></div>
                        </button>
                        
                        <button x-show="capturedImage" @click="retake()" class="px-5 py-2.5 bg-slate-700 text-white rounded-lg font-medium hover:bg-slate-600 transition-colors text-sm">
                            <i class="bi bi-arrow-counterclockwise mr-1"></i> Tekrar
                        </button>

                        <button x-show="capturedImage && !loading" @click="analyze()" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold transition-all shadow-lg shadow-indigo-500/20 text-sm">
                            <i class="bi bi-search mr-1"></i> Analiz Et
                        </button>
                    </div>
                </div>

                <!-- UPLOAD MODE -->
                <div x-show="mode === 'upload'" class="w-full h-full flex flex-col items-center justify-center">
                     <div class="w-full aspect-[4/3] border border-dashed border-slate-600 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-500/5 transition-colors relative group overflow-hidden"
                          @click="$refs.fileInput.click()"
                          @dragover.prevent="dragging = true"
                          @dragleave.prevent="dragging = false"
                          @drop.prevent="handleDrop($event)"
                          :class="dragging ? 'border-indigo-500 bg-indigo-500/10' : ''">
                        
                        <input type="file" x-ref="fileInput" accept="image/*" class="hidden" @change="handleFileSelect($event)">
                        
                        <!-- Placeholder -->
                        <div x-show="!capturedImage" class="text-center p-6">
                            <i class="bi bi-image text-4xl text-slate-600 mb-3 group-hover:text-slate-500 transition-colors block"></i>
                            <p class="text-slate-400 font-semibold text-sm">Fotoğraf Seç veya Sürükle</p>
                        </div>
                        
                        <!-- Preview -->
                        <img x-show="capturedImage" :src="capturedImage" class="absolute inset-0 w-full h-full object-contain bg-black/50">
                        
                     </div>

                     <div class="mt-6" x-show="capturedImage && !loading">
                        <button @click="analyze()" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold transition-all shadow-lg shadow-indigo-500/20 text-sm">
                            <i class="bi bi-search mr-1"></i> Analiz Et
                        </button>
                     </div>
                </div>

            </div>
            
            <!-- Right: Results Area -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl p-6 shadow-xl h-full min-h-[400px]">
                <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2 pb-4 border-b border-slate-700">
                    <i class="bi bi-list-stars text-indigo-400"></i> Sonuçlar
                </h2>
                
                <!-- Loading State -->
                <div x-show="loading" class="flex flex-col items-center justify-center h-64 text-center">
                    <div class="w-8 h-8 border-2 border-slate-700 border-t-indigo-500 rounded-full animate-spin mb-3"></div>
                    <p class="text-indigo-400 font-semibold text-sm animate-pulse">Analiz yapılıyor...</p>
                    <p class="text-slate-500 text-xs mt-1">Veritabanı taranıyor</p>
                </div>
                
                <!-- Empty State -->
                <div x-show="!loading && results.length === 0" class="flex flex-col items-center justify-center h-64 text-center text-slate-500">
                    <i class="bi bi-search text-3xl mb-3 opacity-20"></i>
                    <p class="text-sm">Henüz analiz yapılmadı.</p>
                </div>
                
                <!-- Results List -->
                <div x-show="!loading && results.length > 0" class="space-y-3 animate-fade-in-up">
                    <template x-for="(match, index) in results" :key="index">
                        <div class="bg-slate-700/30 rounded-lg p-3 flex items-center gap-3 hover:bg-slate-700/50 transition-colors border border-slate-700/50 relative overflow-hidden group">
                            <!-- Rank Badge -->
                            <div class="absolute top-0 left-0 bg-slate-800 px-1.5 py-0.5 rounded-br text-[10px] font-bold text-slate-500 font-mono" x-text="'#' + (index + 1)"></div>
                            
                            <!-- Image -->
                            <div class="w-12 h-12 rounded-lg shrink-0 overflow-hidden ring-1 ring-white/10 relative bg-slate-800">
                                <template x-if="match.image">
                                    <img :src="match.image" class="w-full h-full object-cover">
                                </template>
                                <template x-if="!match.image">
                                    <div class="w-full h-full bg-indigo-900 flex items-center justify-center text-sm font-bold text-indigo-200" x-text="match.name[0]"></div>
                                </template>
                            </div>
                            
                            <!-- Info -->
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                    <h3 class="font-bold text-sm text-white truncate" x-text="match.name"></h3>
                                    <span class="text-xs font-bold font-mono" 
                                          :class="index === 0 ? 'text-emerald-400' : 'text-slate-400'" 
                                          x-text="match.score + '%'"></span>
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-1000 ease-out"
                                         :class="index === 0 ? 'bg-emerald-500' : 'bg-indigo-500'"
                                         :style="`width: ${match.score}%`"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
            </div>
        </div>
    </div>
</div>

<script>
function lookalikeApp() {
    return {
        mode: 'webcam', // webcam | upload
        streamActive: false,
        capturedImage: null, // Data URL
        uploadFile: null,
        loading: false,
        results: [],
        dragging: false,

        init() {
            console.log("Lookalike App Init");
        },

        async startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                this.$refs.video.srcObject = stream;
                this.streamActive = true;
            } catch (err) {
                alert("Kamera erişimi reddedildi veya bulunamadı.");
                console.error(err);
            }
        },

        stopCamera() {
            const video = this.$refs.video;
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
            }
            this.streamActive = false;
        },

        capture() {
            const video = this.$refs.video;
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Mirror flip
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            
            ctx.drawImage(video, 0, 0);
            
            this.capturedImage = canvas.toDataURL('image/jpeg');
            this.stopCamera();
        },

        retake() {
            this.capturedImage = null;
            this.results = [];
            this.uploadFile = null;
            if (this.mode === 'webcam') this.startCamera();
        },

        reset() {
            this.stopCamera();
            this.capturedImage = null;
            this.uploadFile = null;
            this.results = [];
        },

        handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) this.processFile(file);
        },

        handleDrop(e) {
            this.dragging = false;
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) this.processFile(file);
        },

        processFile(file) {
            this.uploadFile = file;
            const reader = new FileReader();
            reader.onload = (e) => this.capturedImage = e.target.result;
            reader.readAsDataURL(file);
        },

        async analyze() {
            this.loading = true;
            this.results = [];
            
            const formData = new FormData();
            
            if (this.mode === 'upload' && this.uploadFile) {
                formData.append('image', this.uploadFile);
            } else if (this.capturedImage) {
                formData.append('frame', this.capturedImage);
            } else {
                alert("Görüntü yok!");
                this.loading = false;
                return;
            }

            try {
                const response = await fetch('{% url "core:api_analyze_lookalike" %}', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.results = data.matches;
                } else {
                    alert('Hata: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('Sunucu hatası oluştu.');
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>

<style>
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
</style>
{% endblock %}
