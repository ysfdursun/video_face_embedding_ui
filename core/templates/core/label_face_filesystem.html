{% extends 'core/base.html' %}
{% load static %}

{% block title %}Yüz Etiketleme Sistemi{% endblock %}

{% block content %}
<script defer src="{% static 'core/vendor/alpine.min.js' %}"></script>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 px-4 py-8">
    
    <!-- FİLM SEÇİM AŞAMASI -->
    {% if action == 'select_movie' %}
    <div class="max-w-7xl mx-auto">
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                <i class="bi bi-film text-blue-600"></i>
                Film Seçimi
            </h2>
            <p class="text-gray-600 mt-2">Etiketlemek istediğiniz filmi seçin</p>
        </div>
        
        {% if movies %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {% for movie in movies %}
            <div class="group relative bg-white rounded-xl shadow-sm hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">
                <button onclick="deleteMovie(event, '{{ movie.name }}')" 
                        class="absolute top-3 right-3 z-10 bg-red-500 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-red-600 hover:scale-110"
                        title="Filmi Sil">
                    <i class="bi bi-trash3-fill"></i>
                </button>
                
                <a href="{% url 'core:label_all_faces' %}?movie={{ movie.name }}" class="block p-6">
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="bi bi-camera-reels text-6xl text-blue-600 group-hover:scale-110 transition-transform duration-300"></i>
                        </div>
                        <h5 class="text-lg font-semibold text-gray-900 mb-3">{{ movie.name }}</h5>
                        <div class="inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-full">
                            <i class="bi bi-people-fill"></i>
                            <span>{{ movie.group_count }} Grup</span>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-xl shadow-sm p-12 text-center">
            <i class="bi bi-inbox text-8xl text-gray-300"></i>
            <h5 class="text-xl font-semibold text-gray-700 mt-4">Henüz İşlenmiş Film Yok</h5>
            <p class="text-gray-500 mt-2">Lütfen önce video yükleyin ve işleyin.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- GRUP ETİKETLEME AŞAMASI -->
    {% elif action == 'label_groups' %}
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                    <i class="bi bi-camera-reels text-blue-600"></i>
                    {{ movie_title }}
                </h2>
                <p class="text-gray-600 mt-2">
                    <i class="bi bi-people-fill mr-2"></i>Toplam {{ pagination.total_count }} grup
                </p>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Pagination -->
                {% if pagination.total_pages > 1 %}
                <div class="flex items-center bg-white rounded-lg shadow-sm border border-gray-200">
                    {% if pagination.has_previous %}
                    <a href="?movie={{ movie_title }}&page={{ pagination.current_page|add:'-1' }}" class="px-3 py-2 border-r hover:bg-gray-50 text-gray-600">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    {% else %}
                    <span class="px-3 py-2 border-r text-gray-300 cursor-not-allowed"><i class="bi bi-chevron-left"></i></span>
                    {% endif %}
                    
                    <span class="px-4 py-2 text-sm font-medium text-gray-700">
                        Sayfa {{ pagination.current_page }} / {{ pagination.total_pages }}
                    </span>
                    
                    {% if pagination.has_next %}
                    <a href="?movie={{ movie_title }}&page={{ pagination.current_page|add:'1' }}" class="px-3 py-2 border-l hover:bg-gray-50 text-gray-600">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                    {% else %}
                    <span class="px-3 py-2 border-l text-gray-300 cursor-not-allowed"><i class="bi bi-chevron-right"></i></span>
                    {% endif %}
                </div>
                {% endif %}

                <a href="{% url 'core:label_all_faces' %}" 
                   class="flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200">
                    <i class="bi bi-arrow-left"></i>
                    Geri Dön
                </a>
            </div>
        </div>
        
        {% if groups %}
        <div class="space-y-4">
            {% for group in groups %}
            <div x-data="{ open: false }" class="bg-white rounded-xl shadow-sm overflow-hidden group-container-{{ group.id }}">
                <button @click="open = !open" 
                        class="w-full flex items-center justify-between p-5 hover:bg-gray-50 transition-colors duration-200 border-l-4 border-blue-600">
                    <div class="flex items-center gap-3">
                        <i class="bi bi-people-fill text-2xl text-blue-600"></i>
                        <span class="text-lg font-semibold text-gray-900">{{ group.id }}</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                            <i class="bi bi-person-badge mr-1"></i>{{ group.faces|length }} yüz
                        </span>
                    </div>
                    <i class="bi text-gray-400 text-xl transition-transform duration-200"
                       :class="open ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                </button>
                
                <div x-show="open" 
                     x-collapse
                     class="p-6 bg-gray-50 border-t border-gray-200">
                    
                    <!-- Yüzler Grid: Optimized Images & Lazy Loading -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 mb-6 max-h-96 overflow-y-auto">
                        {% for face_path in group.faces %}
                        <div class="group relative">
                            <img src="{{ MEDIA_URL }}{{ face_path }}"
                                 loading="lazy"
                                 class="w-full aspect-square object-cover rounded-lg shadow-sm group-hover:scale-105 group-hover:brightness-75 transition-all duration-200 bg-gray-200">
                            
                            <div class="absolute inset-0 flex items-center justify-center bg-red-500 bg-opacity-0 group-hover:bg-opacity-90 rounded-lg transition-all duration-200 opacity-0 group-hover:opacity-100">
                                <button type="button" 
                                        onclick="deleteSingleFace('{{ face_path }}', this)"
                                        class="bg-white text-red-500 p-2 rounded-lg hover:scale-110 transition-transform duration-200">
                                    <i class="bi bi-trash3-fill text-xl"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Etiketleme Formu (AJAX) -->
                    <div x-data="{ 
                        selectedActor: '', 
                        showSearch: false,
                        searchQuery: '',
                        allActors: [{% for actor in all_actors %}'{{ actor|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                        get filteredActors() {
                            if (!this.searchQuery) return this.allActors;
                            return this.allActors.filter(actor => 
                                actor.toLowerCase().includes(this.searchQuery.toLowerCase())
                            );
                        },
                        performAction(action) {
                            handleGroupAction(action, '{{ group.id }}', this.selectedActor, '{{ movie_title }}', $el);
                        }
                    }" class="border-t border-gray-300 pt-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-900 mb-2">
                                    <i class="bi bi-person-check-fill text-blue-600 mr-2"></i>
                                    Bu grup hangi oyuncuya ait?
                                </label>
                                <select x-model="selectedActor" 
                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                                    <option value="" disabled>Oyuncu seçiniz...</option>
                                    {% for member in cast_list %}
                                    <option value="{{ member }}">{{ member }}</option>
                                    {% endfor %}
                                </select>
                                
                                <button @click="showSearch = !showSearch" 
                                        type="button"
                                        class="mt-2 text-sm text-gray-600 hover:text-blue-600 transition-colors duration-200">
                                    <i class="bi bi-search mr-1"></i>
                                    Listede yok mu? Tüm aktörlerden ara
                                </button>
                                
                                <div x-show="showSearch" x-collapse class="mt-3 space-y-2">
                                    <input x-model="searchQuery" 
                                           type="text" 
                                           placeholder="Aktör adı yazın..."
                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    
                                    <select @change="selectedActor = $event.target.value; showSearch = false; searchQuery = ''" 
                                            size="5"
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <template x-for="actor in filteredActors" :key="actor">
                                            <option :value="actor" x-text="actor"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button type="button"
                                        @click="performAction('save')"
                                        :disabled="!selectedActor"
                                        class="w-full py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-semibold rounded-lg transition-all duration-200 hover:-translate-y-1 hover:shadow-lg disabled:hover:translate-y-0 disabled:hover:shadow-none">
                                    <i class="bi bi-check-circle-fill mr-2"></i>
                                    Grubu Kaydet
                                </button>
                                
                                <button type="button" 
                                        @click="performAction('discard')"
                                        class="w-full py-3 bg-white hover:bg-red-600 text-red-600 hover:text-white font-semibold rounded-lg border-2 border-red-600 transition-all duration-200 hover:-translate-y-1 hover:shadow-lg">
                                    <i class="bi bi-trash3-fill mr-2"></i>
                                    Grubu Sil
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-xl shadow-sm p-12 text-center">
            <i class="bi bi-info-circle text-8xl text-blue-600"></i>
            <h5 class="text-xl font-semibold text-gray-700 mt-4">Grup Bulunamadı</h5>
            <p class="text-gray-500 mt-2">Bu sayfada gösterilecek grup yok.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function handleGroupAction(action, groupId, assignedCastName, movieTitle, buttonElement) {
    const csrftoken = getCookie('csrftoken');
    
    // UI Feedback
    const container = document.querySelector(`.group-container-${groupId}`);
    container.style.opacity = '0.5';
    container.style.pointerEvents = 'none';

    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            action: action,
            group_id: groupId,
            assigned_cast_name: assignedCastName,
            movie: movieTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove element nicely
            container.style.transition = 'all 0.5s ease';
            container.style.transform = 'translateX(100px)';
            container.style.opacity = '0';
            setTimeout(() => {
                container.remove();
                // Check if no groups left, reload to get next page or show empty state
                if (document.querySelectorAll('[class*="group-container-"]').length === 0) {
                    window.location.reload();
                }
            }, 500);
        } else {
            alert('İşlem başarısız: ' + (data.message || 'Bilinmeyen hata'));
            container.style.opacity = '1';
            container.style.pointerEvents = 'auto';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluştu.');
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
    });
}

function deleteSingleFace(facePath, button) {
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('{% url "core:delete_single_face" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: 'face_path=' + encodeURIComponent(facePath)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const parentDiv = button.closest('.group');
            if (parentDiv) {
                parentDiv.style.transition = 'all 0.3s ease';
                parentDiv.style.opacity = '0';
                parentDiv.style.transform = 'scale(0.8)';
                setTimeout(() => parentDiv.remove(), 300);
            }
        } else {
            alert('❌ ' + data.message);
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-trash3-fill text-xl"></i>';
        }
    })
    .catch(error => {
        alert('Silme işlemi başarısız oldu');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash3-fill text-xl"></i>';
    });
}

function deleteMovie(event, movieName) {
    event.preventDefault();
    event.stopPropagation();
    
    if (!confirm(`"${movieName}" filminin TÜM fotoğrafları silinecek. Emin misiniz?`)) {
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('/label/delete_movie/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ movie_name: movieName })
    })
    .then(response => response.json())
    .then(data => {
        location.reload();
    })
    .catch(error => {
        location.reload();
    });
}
</script>
{% endblock %}
