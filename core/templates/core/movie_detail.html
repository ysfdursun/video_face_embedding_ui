{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ movie.title }} - Oyuncu Kadrosu{% endblock %}

{% block content %}
<div x-data="movieCastManager()" 
     class="min-h-screen bg-slate-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Breadcrumb -->
        <nav class="flex mb-8" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'core:movies_dashboard' %}" class="inline-flex items-center text-sm font-medium text-slate-700 hover:text-indigo-600">
                        <i class="bi bi-collection-play-fill mr-2"></i>
                        Filmler
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="bi bi-chevron-right text-slate-400 mx-2"></i>
                        <span class="text-sm font-medium text-slate-500">{{ movie.title }}</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Movie Header Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 mb-12 relative">
             <!-- Use a separate div for the background/overflow-hidden part so dropdowns can spill out if needed, 
                  OR just fix z-index if inside. 
                  If I remove overflow-hidden from the parent, the rounded corners might look square on the image.
                  Let's try z-index fix first on the content content wrapper. -->
            <div class="relative h-64 bg-slate-900 rounded-t-2xl">
                <!-- Background Visuals Wrapper (Clipped) -->
                <div class="absolute inset-0 rounded-t-2xl overflow-hidden z-0">
                    <!-- Abstract Background generated from cast -->
                    <div class="absolute inset-0 grid grid-cols-4 opacity-30 blur-xl scale-110">
                        {% for member in cast|slice:":4" %}
                            {% if member.image %}
                            <img src="{{ MEDIA_URL }}{{ member.image }}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="bg-slate-800 w-full h-full"></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <!-- Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent"></div>
                </div>
                
                <!-- Content & Controls (Not Clipped) -->
                <!-- Added z-20 to ensure this sits ABOVE the gradient -->
                <div class="absolute bottom-0 left-0 p-8 w-full flex justify-between items-end z-20">
                    <div>
                        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 shadow-sm">{{ movie.title }}</h1>
                        <div class="flex items-center gap-4 text-slate-300">
                            <span class="flex items-center gap-1 bg-slate-800/80 px-3 py-1 rounded-full text-sm backdrop-blur-sm border border-slate-700">
                                <i class="bi bi-people-fill text-indigo-400"></i> <span x-text="castMembers.length"></span> Oyuncu
                            </span>
                            <span class="flex items-center gap-1 bg-slate-800/80 px-3 py-1 rounded-full text-sm backdrop-blur-sm border border-slate-700">
                                <i class="bi bi-film text-indigo-400"></i> Film
                            </span>
                        </div>
                    </div>

                    <!-- Cast Management Controls -->
                    <div class="flex items-center gap-2">
                         <!-- Add Cast -->
                         <div x-data="{ open: false, query: '' }" class="relative">
                            <button @click="open = !open; $nextTick(() => $refs.castInput.focus())" 
                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold transition-colors flex items-center gap-2 shadow-lg">
                                <i class="bi bi-person-plus-fill"></i> Kadroya Ekle
                            </button>
                            
                            <div x-show="open" @click.away="open = false" 
                                 class="absolute bottom-full right-0 mb-2 w-64 bg-white border border-slate-200 rounded-xl shadow-xl z-50 p-3 text-slate-900" 
                                 style="display: none;">
                                <div class="text-xs font-semibold text-slate-500 mb-2 uppercase">Oyuncu Ekle</div>
                                <input x-ref="castInput" x-model="query" type="text" placeholder="Aktör ara..." class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg mb-2 focus:ring-2 focus:ring-indigo-500 text-slate-900">
                                <div class="max-h-48 overflow-y-auto space-y-1">
                                    <template x-for="actor in allActors.filter(a => a.toLowerCase().includes(query.toLowerCase()) && !castMembers.includes(a)).slice(0, 50)">
                                        <button @click="addActorToCast(actor); open = false; query = ''" class="w-full text-left px-3 py-2 hover:bg-indigo-50 text-sm text-slate-700 rounded-lg flex items-center justify-between group">
                                            <span x-text="actor"></span>
                                            <i class="bi bi-plus-circle text-indigo-400 opacity-0 group-hover:opacity-100"></i>
                                        </button>
                                    </template>
                                    <div x-show="query && allActors.filter(a => a.toLowerCase().includes(query.toLowerCase()) && !castMembers.includes(a)).length === 0" class="text-center py-2 text-xs text-slate-400">Sonuç yok</div>
                                </div>
                            </div>
                        </div>

                        <!-- Remove Cast -->
                        <div x-data="{ open: false, query: '' }" class="relative">
                            <button @click="open = !open; $nextTick(() => $refs.removeInput.focus())" 
                                    class="px-4 py-2 bg-slate-800/80 hover:bg-red-600 text-white border border-slate-700 rounded-lg text-sm font-bold transition-colors flex items-center gap-2 backdrop-blur-sm">
                                <i class="bi bi-person-dash"></i> Sil
                            </button>
                            
                            <div x-show="open" @click.away="open = false" 
                                 class="absolute bottom-full right-0 mb-2 w-64 bg-white border border-slate-200 rounded-xl shadow-xl z-50 p-3 text-slate-900" 
                                 style="display: none;">
                                <div class="text-xs font-semibold text-slate-500 mb-2 uppercase">Oyuncu Çıkar</div>
                                <input x-ref="removeInput" x-model="query" type="text" placeholder="Kadroda ara..." class="w-full px-3 py-2 text-sm border border-slate-200 rounded-lg mb-2 focus:ring-2 focus:ring-red-500 text-slate-900">
                                <div class="max-h-48 overflow-y-auto space-y-1">
                                    <template x-for="member in castMembers.filter(m => m.toLowerCase().includes(query.toLowerCase())).slice(0, 50)">
                                        <div class="flex items-center justify-between px-3 py-2 hover:bg-red-50 rounded-lg group">
                                            <span x-text="member" class="text-sm text-slate-700 truncate"></span>
                                            <button @click="removeActorFromCast(member)" class="text-slate-400 hover:text-red-500 transition-colors" title="Çıkar">
                                                <i class="bi bi-trash3"></i>
                                            </button>
                                        </div>
                                    </template>
                                    <div x-show="castMembers.length === 0" class="text-center py-2 text-xs text-slate-400">Kadro boş</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cast Grid -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center gap-2">
                <i class="bi bi-person-lines-fill text-indigo-600"></i>
                Oyuncu Kadrosu
            </h2>
            
            <!-- Checks against castMembers length for reactivity -->
            <template x-if="castMembers.length > 0">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- We iterate over the original valid casts from Django first, effectively using the static list for images 
                         BUT we need to handle dynamic additions? 
                         Actually, dynamically added actors won't have images until refresh unless we pass image map.
                         For now, let's keep the static rendered list for visual richness, and maybe just show a reload toast if changed?
                         OR relies on reload.
                         User request implied just adding/removing capability. 
                         For best UX, we should reload page or update list. 
                         Since images come from DB/disk, auto-reload on change is safest for visuals.
                    -->
                   {% for actor in cast %}
                    <a href="{% url 'core:actor_detail' actor.name %}" class="group" x-show="castMembers.includes('{{ actor.name }}')">
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all overflow-hidden h-full">
                            <div class="aspect-[3/4] bg-slate-100 relative overflow-hidden">
                                {% if actor.image %}
                                    <img src="{{ MEDIA_URL }}{{ actor.image }}" 
                                         alt="{{ actor.display_name }}"
                                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                         loading="lazy">
                                {% else %}
                                    <div class="w-full h-full flex flex-col items-center justify-center text-slate-400">
                                        <i class="bi bi-person-fill text-6xl mb-2"></i>
                                    </div>
                                {% endif %}
                                
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end justify-center p-4">
                                    <span class="text-white text-sm font-medium">Profili Gör</span>
                                </div>
                            </div>
                            <div class="p-3 text-center">
                                <h3 class="font-bold text-slate-900 truncate">{{ actor.display_name }}</h3>
                                <p class="text-xs text-slate-500">Oyuncu</p>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                    
                    <!-- Simulating new additions (no image) -->
                    <template x-for="member in castMembers.filter(m => !originalCastNames.includes(m))">
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col items-center justify-center h-full min-h-[250px] animate-pulse">
                            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-500 mb-3">
                                <i class="bi bi-person-check-fill text-3xl"></i>
                            </div>
                            <h3 class="font-bold text-slate-900 truncate max-w-full" x-text="member"></h3>
                            <p class="text-xs text-green-600 mt-1">Yeni Eklendi</p>
                            <p class="text-[10px] text-slate-400 mt-2 text-center">Resmi görmek için<br>sayfayı yenileyin</p>
                        </div>
                    </template>
                </div>
            </template>

            <template x-if="castMembers.length === 0">
                <div class="bg-white rounded-xl border border-slate-200 p-12 text-center">
                    <i class="bi bi-person-x text-slate-300 text-6xl mb-4 block"></i>
                    <h3 class="text-lg font-semibold text-slate-900">Oyuncu Bulunamadı</h3>
                    <p class="text-slate-500">Bu film için henüz oyuncu etiketlenmemiş.</p>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function movieCastManager() {
    return {
        castMembers: {{ cast_names|safe }},
        originalCastNames: {{ cast_names|safe }},
        allActors: {{ all_actors|safe }},
        movieTitle: "{{ movie.title|escapejs }}",
        
        async addActorToCast(actorName) {
            if (this.castMembers.includes(actorName)) return;

            try {
                const response = await fetch("{% url 'core:api_cast_manage' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'add',
                        movie: this.movieTitle,
                        actor: actorName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.castMembers.push(actorName);
                    // Show simple toast? For now just UI update
                } else {
                    alert("Ekleme başarısız: " + (data.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error("Error adding cast:", error);
                alert("Bir hata oluştu.");
            }
        },

        async removeActorFromCast(actorName) {
            if (!confirm(actorName + " adlı oyuncuyu kadrodan çıkarmak istediğinize emin misiniz?")) return;

            try {
                const response = await fetch("{% url 'core:api_cast_manage' %}", {
                    method: 'DELETE', // Using DELETE per your previous implementation
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        movie: this.movieTitle,
                        actor: actorName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.castMembers = this.castMembers.filter(m => m !== actorName);
                } else {
                    alert("Silme başarısız: " + (data.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error("Error removing cast:", error);
                alert("Bir hata oluştu.");
            }
        }
    }
}
</script>
{% endblock %}
